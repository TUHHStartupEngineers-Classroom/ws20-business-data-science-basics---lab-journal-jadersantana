<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jader Santana" />

<meta name="date" content="2020-11-23" />

<title>Journal (reproducible report)</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">MyLabJournal</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="journal.html">Journal</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Class notes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="dictionary.html">Dictionary</a>
    </li>
    <li>
      <a href="data_wrangling.html">Data Wrangling</a>
    </li>
    <li>
      <a href="ggplot_graphs.html">ggplot graphs</a>
    </li>
    <li>
      <a href="machine_learning.html">machine learning</a>
    </li>
  </ul>
</li>
<li>
  <a href="links.html">Links</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Journal (reproducible report)</h1>
<h4 class="author">Jader Santana</h4>
<h4 class="date">2020-11-23</h4>

</div>


<div id="challenge-01_intro_r-introduction-to-r-rstudio-ide-github" class="section level1">
<h1><span class="header-section-number">1</span> Challenge 01_intro_r Introduction to R, RStudio IDE &amp; Github</h1>
<p>no specific challenge for this unit</p>
</div>
<div id="challenge-02_intro_tv-intro-to-tidyverse" class="section level1">
<h1><span class="header-section-number">2</span> Challenge 02_intro_tv Intro to tidyverse</h1>
<p>Last compiled: 2021-01-20 22:05:10</p>
<div id="load-libraries--" class="section level2">
<h2><span class="header-section-number">2.1</span> 1.0 Load libraries —-</h2>
<pre class="r"><code>library(tidyverse)
#  library(tibble)    --&gt; is a modern re-imagining of the data frame
#  library(readr)     --&gt; provides a fast and friendly way to read rectangular data like csv
#  library(dplyr)     --&gt; provides a grammar of data manipulation
#  library(magrittr)  --&gt; offers a set of operators which make your code more readable (pipe operator)
#  library(tidyr)     --&gt; provides a set of functions that help you get to tidy data
#  library(stringr)   --&gt; provides a cohesive set of functions designed to make working with strings as easy as possible
#  library(ggplot2)   --&gt; graphics


# Excel Files
library(readxl)</code></pre>
</div>
<div id="importing-files--" class="section level2">
<h2><span class="header-section-number">2.2</span> 2.0 Importing Files —-</h2>
<pre class="r"><code># A good convention is to use the file name and suffix it with tbl for the data structure tibble
bikes_tbl      &lt;- read_excel(path = &quot;00_data/01_bike_sales/01_raw_data/bikes.xlsx&quot;)
orderlines_tbl &lt;- read_excel(&quot;00_data/01_bike_sales/01_raw_data/orderlines.xlsx&quot;)

# Not necessary for this analysis, but for the sake of completeness
bikeshops_tbl  &lt;- read_excel(&quot;00_data/01_bike_sales/01_raw_data/bikeshops.xlsx&quot;)</code></pre>
</div>
<div id="examining-data--" class="section level2">
<h2><span class="header-section-number">2.3</span> 3.0 Examining Data —-</h2>
<pre class="r"><code>bikeshops_tbl</code></pre>
<pre><code>## # A tibble: 30 x 5
##    bikeshop.id name                  location                          lat   lng
##          &lt;dbl&gt; &lt;chr&gt;                 &lt;chr&gt;                           &lt;dbl&gt; &lt;dbl&gt;
##  1           1 Zum Goldenen Lenker   Berlin, Berlin                   52.5 13.4 
##  2           2 AlexandeRad           Hamburg, Hamburg                 53.6 10.0 
##  3           3 Fahrradladen 16       Munich, Bavaria                  48.2 11.6 
##  4           4 Bikestation Köln      Cologne, North Rhine-Westphalia  50.9  6.95
##  5           5 Montimare             Frankfurt, Hesse                 50.1  8.68
##  6           6 fahrschneller         Stuttgart, Baden-Württemberg     48.8  9.18
##  7           7 Rad Ab                Düsseldorf, North Rhine-Westph~  51.2  6.79
##  8           8 Lucky Bike            Dortmund, North Rhine-Westphal~  51.5  7.47
##  9           9 Zweirad-Center Stadl~ Essen, North Rhine-Westphalia    51.5  7.01
## 10          10 WITT-RAD              Bremen, Bremen                   53.1  8.83
## # ... with 20 more rows</code></pre>
<pre class="r"><code>glimpse(bikeshops_tbl)</code></pre>
<pre><code>## Rows: 30
## Columns: 5
## $ bikeshop.id &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, ...
## $ name        &lt;chr&gt; &quot;Zum Goldenen Lenker&quot;, &quot;AlexandeRad&quot;, &quot;Fahrradladen 16&quot;...
## $ location    &lt;chr&gt; &quot;Berlin, Berlin&quot;, &quot;Hamburg, Hamburg&quot;, &quot;Munich, Bavaria&quot;...
## $ lat         &lt;dbl&gt; 52.51667, 53.57532, 48.15000, 50.93333, 50.11552, 48.78...
## $ lng         &lt;dbl&gt; 13.400000, 10.015340, 11.583333, 6.950000, 8.684167, 9....</code></pre>
</div>
<div id="joining-data--" class="section level2">
<h2><span class="header-section-number">2.4</span> 4.0 Joining Data —-</h2>
<pre class="r"><code>left_join(orderlines_tbl, bikes_tbl, by = c(&quot;product.id&quot; = &quot;bike.id&quot;))</code></pre>
<pre><code>## # A tibble: 15,644 x 15
##    ...1  order.id order.line order.date          customer.id product.id quantity
##    &lt;chr&gt;    &lt;dbl&gt;      &lt;dbl&gt; &lt;dttm&gt;                    &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
##  1 1            1          1 2015-01-07 00:00:00           2       2681        1
##  2 2            1          2 2015-01-07 00:00:00           2       2411        1
##  3 3            2          1 2015-01-10 00:00:00          10       2629        1
##  4 4            2          2 2015-01-10 00:00:00          10       2137        1
##  5 5            3          1 2015-01-10 00:00:00           6       2367        1
##  6 6            3          2 2015-01-10 00:00:00           6       1973        1
##  7 7            3          3 2015-01-10 00:00:00           6       2422        1
##  8 8            3          4 2015-01-10 00:00:00           6       2655        1
##  9 9            3          5 2015-01-10 00:00:00           6       2247        1
## 10 10           4          1 2015-01-11 00:00:00          22       2408        1
## # ... with 15,634 more rows, and 8 more variables: model &lt;chr&gt;,
## #   model.year &lt;dbl&gt;, frame.material &lt;chr&gt;, weight &lt;dbl&gt;, price &lt;dbl&gt;,
## #   category &lt;chr&gt;, gender &lt;chr&gt;, url &lt;chr&gt;</code></pre>
<pre class="r"><code>bike_orderlines_joined_tbl &lt;- orderlines_tbl %&gt;%
  left_join(bikes_tbl, by = c(&quot;product.id&quot; = &quot;bike.id&quot;)) %&gt;%
  left_join(bikeshops_tbl, by = c(&quot;customer.id&quot; = &quot;bikeshop.id&quot;))
bike_orderlines_joined_tbl %&gt;% glimpse()</code></pre>
<pre><code>## Rows: 15,644
## Columns: 19
## $ ...1           &lt;chr&gt; &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;10&quot;, &quot;...
## $ order.id       &lt;dbl&gt; 1, 1, 2, 2, 3, 3, 3, 3, 3, 4, 5, 5, 5, 5, 6, 6, 6, 6...
## $ order.line     &lt;dbl&gt; 1, 2, 1, 2, 1, 2, 3, 4, 5, 1, 1, 2, 3, 4, 1, 2, 3, 4...
## $ order.date     &lt;dttm&gt; 2015-01-07, 2015-01-07, 2015-01-10, 2015-01-10, 201...
## $ customer.id    &lt;dbl&gt; 2, 2, 10, 10, 6, 6, 6, 6, 6, 22, 8, 8, 8, 8, 16, 16,...
## $ product.id     &lt;dbl&gt; 2681, 2411, 2629, 2137, 2367, 1973, 2422, 2655, 2247...
## $ quantity       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1...
## $ model          &lt;chr&gt; &quot;Spectral CF 7 WMN&quot;, &quot;Ultimate CF SLX Disc 8.0 ETAP&quot;...
## $ model.year     &lt;dbl&gt; 2021, 2020, 2021, 2019, 2020, 2020, 2020, 2021, 2020...
## $ frame.material &lt;chr&gt; &quot;carbon&quot;, &quot;carbon&quot;, &quot;carbon&quot;, &quot;carbon&quot;, &quot;aluminium&quot;,...
## $ weight         &lt;dbl&gt; 13.80, 7.44, 14.06, 8.80, 11.50, 8.80, 8.20, 8.85, 1...
## $ price          &lt;dbl&gt; 3119, 5359, 2729, 1749, 1219, 1359, 2529, 1559, 3899...
## $ category       &lt;chr&gt; &quot;Mountain - Trail - Spectral&quot;, &quot;Road - Race - Ultima...
## $ gender         &lt;chr&gt; &quot;female&quot;, &quot;unisex&quot;, &quot;unisex&quot;, &quot;unisex&quot;, &quot;unisex&quot;, &quot;u...
## $ url            &lt;chr&gt; &quot;https://www.canyon.com/en-de/mountain-bikes/trail-b...
## $ name           &lt;chr&gt; &quot;AlexandeRad&quot;, &quot;AlexandeRad&quot;, &quot;WITT-RAD&quot;, &quot;WITT-RAD&quot;...
## $ location       &lt;chr&gt; &quot;Hamburg, Hamburg&quot;, &quot;Hamburg, Hamburg&quot;, &quot;Bremen, Bre...
## $ lat            &lt;dbl&gt; 53.57532, 53.57532, 53.07379, 53.07379, 48.78234, 48...
## $ lng            &lt;dbl&gt; 10.015340, 10.015340, 8.826754, 8.826754, 9.180819, ...</code></pre>
</div>
<div id="wrangling-data--" class="section level2">
<h2><span class="header-section-number">2.5</span> 5.0 Wrangling Data —-</h2>
<pre class="r"><code># All actions are chained with the pipe already. You can perform each step separately and use glimpse() or View() to validate your code. Store the result in a variable at the end of the steps.
bike_orderlines_wrangled_tbl &lt;- bike_orderlines_joined_tbl %&gt;%
  # 5.1 Separate category name
  separate(col    = location,
           into   = c(&quot;city&quot;, &quot;state&quot;),
           sep    = &quot;, &quot;) %&gt;%
  
  # 5.2 Add the total price (price * quantity) 
  # Add a column to a tibble that uses a formula-style calculation of other columns
  mutate(total.price = price * quantity) %&gt;%
  
  # 5.3 Optional: Reorganize. Using select to grab or remove unnecessary columns
  # 5.3.1 by exact column name
  select(-...1, -gender) %&gt;%
  
  # 5.3.2 by a pattern
  # You can use the select_helpers to define patterns. 
  # Type ?ends_with and click on Select helpers in the documentation
  select(-ends_with(&quot;.id&quot;)) %&gt;%
  
  # 5.3.3 Actually we need the column &quot;order.id&quot;. Let&#39;s bind it back to the data
  bind_cols(bike_orderlines_joined_tbl %&gt;% select(order.id)) %&gt;% 
  
  # 5.3.4 You can reorder the data by selecting the columns in your desired order.
  # You can use select_helpers like contains() or everything()
  select(order.id, contains(&quot;order&quot;), contains(&quot;model&quot;), contains(&quot;category&quot;),
         price, quantity, total.price,
         everything()) %&gt;%
  
  # 5.4 Rename columns because we actually wanted underscores instead of the dots
  # (one at the time vs. multiple at once)
  rename(bikeshop = name) %&gt;%
  set_names(names(.) %&gt;% str_replace_all(&quot;\\.&quot;, &quot;_&quot;))</code></pre>
</div>
<div id="business-insights--" class="section level2">
<h2><span class="header-section-number">2.6</span> 6.0 Business Insights —-</h2>
<div id="sales-by-location--" class="section level3">
<h3><span class="header-section-number">2.6.1</span> 6.1 Sales by Location —-</h3>
<pre class="r"><code>library(lubridate)
# Step 1 - Manipulate
sales_by_location_tbl &lt;- bike_orderlines_wrangled_tbl %&gt;%
  
  # Select columns
  select(state, total_price) %&gt;%
  
  # Add year column
  #no need mutate(year = year(order_date)) %&gt;%
  
  # Grouping by state and summarizing sales
  group_by(state) %&gt;% 
  summarize(sales = sum(total_price)) %&gt;%
  
  # Optional: Add a column that turns the numbers into a currency format 
  # (makes it in the plot optically more appealing)
  # mutate(sales_text = scales::dollar(sales)) &lt;- Works for dollar values
  mutate(sales_text = scales::dollar(sales, big.mark = &quot;.&quot;, 
                                     decimal.mark = &quot;,&quot;, 
                                     prefix = &quot;&quot;, 
                                     suffix = &quot; €&quot;))

sales_by_location_tbl</code></pre>
<pre><code>## # A tibble: 12 x 3
##    state                            sales sales_text  
##    &lt;chr&gt;                            &lt;dbl&gt; &lt;chr&gt;       
##  1 Baden-Württemberg              6521090 6.521.090 € 
##  2 Bavaria                        6742819 6.742.819 € 
##  3 Berlin                         1128433 1.128.433 € 
##  4 Bremen                        10653499 10.653.499 €
##  5 Hamburg                        3874756 3.874.756 € 
##  6 Hesse                          1558901 1.558.901 € 
##  7 Lower Saxony                   4107115 4.107.115 € 
##  8 Mecklenburg-Western Pomerania   618974 618.974 €   
##  9 North Rhine-Westphalia        21200613 21.200.613 €
## 10 Saxony                         2230245 2.230.245 € 
## 11 Saxony-Anhalt                   569614 569.614 €   
## 12 Schleswig-Holstein             3224749 3.224.749 €</code></pre>
<pre class="r"><code># Step 2 - Visualize
sales_by_location_tbl %&gt;%
  
  # Setup canvas with the columns location (x-axis) and sales (y-axis)
  ggplot(aes(x = state, y = sales)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  # Geometries
  geom_col(fill = &quot;#2DC6D6&quot;) + # Use geom_col for a bar plot
  geom_label(aes(label = sales_text)) + # Adding labels to the bars
  geom_smooth(method = &quot;lm&quot;, se = FALSE) + # Adding a trendline
  
  # Formatting
  # scale_y_continuous(labels = scales::dollar) + # Change the y-axis. 
  # Again, we have to adjust it for euro values
  scale_y_continuous(labels = scales::dollar_format(big.mark = &quot;.&quot;, 
                                                    decimal.mark = &quot;,&quot;, 
                                                    prefix = &quot;&quot;, 
                                                    suffix = &quot; €&quot;)) +
  labs(
    title    = &quot;Revenue by Location(state)&quot;,
    subtitle = &quot;Not an upward Trend&quot;,
    x = &quot;&quot;, # Override defaults for x and y
    y = &quot;Revenue&quot;
  )</code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="sales-by-year-and-location--" class="section level3">
<h3><span class="header-section-number">2.6.2</span> 6.2 Sales by Year and Location —-</h3>
<pre class="r"><code># Step 1 - Manipulate
sales_by_loc_year_tbl &lt;- bike_orderlines_wrangled_tbl %&gt;%
  
  # Select columns and add a year
  select(order_date, total_price, state) %&gt;%
  mutate(year = year(order_date)) %&gt;%
  
  # Group by and summarize year and main catgegory
  group_by(year, state) %&gt;%
  summarise(sales = sum(total_price)) %&gt;%
  ungroup() %&gt;%
  
  # Format $ Text
  mutate(sales_text = scales::dollar(sales, big.mark = &quot;.&quot;, 
                                     decimal.mark = &quot;,&quot;, 
                                     prefix = &quot;&quot;, 
                                     suffix = &quot; €&quot;))

sales_by_loc_year_tbl</code></pre>
<pre><code>## # A tibble: 60 x 4
##     year state                           sales sales_text 
##    &lt;int&gt; &lt;chr&gt;                           &lt;dbl&gt; &lt;chr&gt;      
##  1  2015 Baden-Württemberg             1031924 1.031.924 €
##  2  2015 Bavaria                       1301461 1.301.461 €
##  3  2015 Berlin                          95853 95.853 €   
##  4  2015 Bremen                        1395912 1.395.912 €
##  5  2015 Hamburg                        423090 423.090 €  
##  6  2015 Hesse                          308609 308.609 €  
##  7  2015 Lower Saxony                   584386 584.386 €  
##  8  2015 Mecklenburg-Western Pomerania  222003 222.003 €  
##  9  2015 North Rhine-Westphalia        3735092 3.735.092 €
## 10  2015 Saxony                         238371 238.371 €  
## # ... with 50 more rows</code></pre>
<pre class="r"><code># Step 2 - Visualize
sales_by_loc_year_tbl %&gt;%
  
  # Set up x, y, fill
  ggplot(aes(x = year, y = sales, fill = state)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  # Geometries
  geom_col() + # Run up to here to get a stacked bar plot
  
  # Facet
  facet_wrap(~ state) +
  
  # Formatting
  scale_y_continuous(labels = scales::dollar_format(big.mark = &quot;.&quot;, 
                                                    decimal.mark = &quot;,&quot;, 
                                                    prefix = &quot;&quot;, 
                                                    suffix = &quot; €&quot;)) +
  labs(
    title = &quot;Revenue by year and location&quot;,
    subtitle = &quot;Each location has an upward trend&quot;,
    fill = &quot;Main Location&quot; # Changes the legend name
  )</code></pre>
<p><img src="journal_files/figure-html/plot-1.png" width="1248" /></p>
</div>
</div>
</div>
<div id="challenge-03_data-aquisition" class="section level1">
<h1><span class="header-section-number">3</span> Challenge 03_Data Aquisition</h1>
<p>Last compiled: 2021-01-20 22:05:10</p>
<div id="load-libraries---1" class="section level2">
<h2><span class="header-section-number">3.1</span> 1.0 Load libraries —-</h2>
<p>test 2</p>
</div>
</div>
<div id="challenge-04_data-wrangling" class="section level1">
<h1><span class="header-section-number">4</span> Challenge 04_Data Wrangling</h1>
<p>Answer the following questions with that data:</p>
<div id="patent-dominance--" class="section level2">
<h2><span class="header-section-number">4.1</span> 1.0 Patent Dominance —-</h2>
<ol style="list-style-type: decimal">
<li>Patent Dominance: What US company / corporation has the most patents? List the 10 US companies with the most assigned/granted patents.</li>
</ol>
<pre class="r"><code>#install.packages(&quot;vroom&quot;)
#install.packages(&quot;tictoc&quot;)

# Tidyverse
library(tidyverse)
library(vroom)

# Data Table
library(data.table)

# Counter
library(tictoc)



col_types_assignee_tbl &lt;- list(
  id = col_character(),
  type = col_double(),
  name_first = col_character(),
  name_last = col_character(),
  organization = col_character()
)

assignee_tbl &lt;- vroom(
            file       = &quot;00_data/04_challenge/assignee.tsv&quot;, 
            delim      = &quot;\t&quot;, 
            col_types  = col_types_assignee_tbl,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )

#col_types_patent_tbl &lt;- list(
 # id = col_character(),
  #type = col_character(),
  #number = col_character(),
  #country = col_character(),
 # date = col_date(&quot;%Y-%m-%d&quot;),
#  abstract = col_character(),
  #title = col_character(),
 # kind = col_character(),
#  num_claims = col_double(),
  #filename = col_character(),
 # withdrawn = col_double()
#)

#patent_tbl &lt;- vroom(
#            file       = &quot;00_data/04_challenge/patent.tsv&quot;, 
#            delim      = &quot;\t&quot;, 
#            col_types  = col_types_patent_tbl,
#            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
#        )

col_types_patent_assignee_tbl &lt;- list(
  patent_id = col_character(),
  assignee_id = col_character(),
  location_id = col_character()
)

patent_assignee_tbl &lt;- vroom(
            file       = &quot;00_data/04_challenge/patent_assignee.tsv&quot;, 
            delim      = &quot;\t&quot;, 
            col_types  = col_types_patent_assignee_tbl,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )

#col_types_uspc_tbl &lt;- list(
 # uuid = col_character(),
  #patent_id = col_character(),
  #mainclass_id = col_character(),
  #subclass_id = col_character(),
  #sequence = col_double()
#)

#uspc_tbl &lt;- vroom(
 #           file       = &quot;00_data/04_challenge/uspc.tsv&quot;, 
  #          delim      = &quot;\t&quot;, 
   #         col_types  = col_types_uspc_tbl,
    #        na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
     #   )

assignee_tbl %&gt;% glimpse()</code></pre>
<pre><code>## Rows: 512,152
## Columns: 5
## $ id           &lt;chr&gt; &quot;org_000Te6ufduCywtAA6oMB&quot;, &quot;org_001LOvSUTQjgiMNXj5uy&quot;...
## $ type         &lt;dbl&gt; 2, 3, 2, 3, 3, 3, 3, 2, 3, 2, 2, 2, 3, 3, 3, 3, 2, 3, ...
## $ name_first   &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ name_last    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ organization &lt;chr&gt; &quot;Oborain, LLC&quot;, &quot;QUIET THERAPEUTICS LTD.&quot;, &quot;Kinergetic...</code></pre>
<pre class="r"><code>#patent_tbl %&gt;% glimpse()
patent_assignee_tbl %&gt;% glimpse()</code></pre>
<pre><code>## Rows: 6,884,971
## Columns: 3
## $ patent_id   &lt;chr&gt; &quot;4488683&quot;, &quot;5856666&quot;, &quot;5204210&quot;, &quot;5302149&quot;, &quot;D397841&quot;, ...
## $ assignee_id &lt;chr&gt; &quot;org_dJc33162m5Ry3wK7wNeY&quot;, &quot;org_UiBjCdlCCCWxBIxSzRLe&quot;,...
## $ location_id &lt;chr&gt; &quot;208e32d3-0ee9-4393-ad2a-803a31f8b723&quot;, &quot;4f5e4429-aac1-...</code></pre>
<pre class="r"><code>#uspc_tbl %&gt;% glimpse()

class(assignee_tbl)</code></pre>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<pre class="r"><code>#class(patent_tbl)
class(patent_assignee_tbl)</code></pre>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<pre class="r"><code>#class(uspc_tbl)

setDT(assignee_tbl)
#setDT(patent_tbl)
setDT(patent_assignee_tbl)
#setDT(uspc_tbl)

class(assignee_tbl)</code></pre>
<pre><code>## [1] &quot;data.table&quot; &quot;data.frame&quot;</code></pre>
<pre class="r"><code>#class(patent_tbl)
class(patent_assignee_tbl)</code></pre>
<pre><code>## [1] &quot;data.table&quot; &quot;data.frame&quot;</code></pre>
<pre class="r"><code>#class(uspc_tbl)

assignee_tbl %&gt;% glimpse()</code></pre>
<pre><code>## Rows: 512,152
## Columns: 5
## $ id           &lt;chr&gt; &quot;org_000Te6ufduCywtAA6oMB&quot;, &quot;org_001LOvSUTQjgiMNXj5uy&quot;...
## $ type         &lt;dbl&gt; 2, 3, 2, 3, 3, 3, 3, 2, 3, 2, 2, 2, 3, 3, 3, 3, 2, 3, ...
## $ name_first   &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ name_last    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ organization &lt;chr&gt; &quot;Oborain, LLC&quot;, &quot;QUIET THERAPEUTICS LTD.&quot;, &quot;Kinergetic...</code></pre>
<pre class="r"><code>#patent_tbl %&gt;% glimpse()
patent_assignee_tbl %&gt;% glimpse()</code></pre>
<pre><code>## Rows: 6,884,971
## Columns: 3
## $ patent_id   &lt;chr&gt; &quot;4488683&quot;, &quot;5856666&quot;, &quot;5204210&quot;, &quot;5302149&quot;, &quot;D397841&quot;, ...
## $ assignee_id &lt;chr&gt; &quot;org_dJc33162m5Ry3wK7wNeY&quot;, &quot;org_UiBjCdlCCCWxBIxSzRLe&quot;,...
## $ location_id &lt;chr&gt; &quot;208e32d3-0ee9-4393-ad2a-803a31f8b723&quot;, &quot;4f5e4429-aac1-...</code></pre>
<pre class="r"><code>#uspc_tbl %&gt;% glimpse()

# 4.0 DATA WRANGLING ----
# 4.1 Joining / Merging Data ----

tic()
combined_assignee_patent_assignee_tbl &lt;- merge(x = assignee_tbl, y = patent_assignee_tbl, 
                       by.x = &quot;id&quot;, by.y = &quot;assignee_id&quot;,
                       all.x = TRUE, 
                       all.y = TRUE)%&gt;%
mutate(patents_unit=1)%&gt;%
 group_by(organization) %&gt;%
  summarize(number_of_patents = sum(patents_unit)) %&gt;%
  ungroup()%&gt;%
  arrange(number_of_patents)
toc()</code></pre>
<pre><code>## 39.89 sec elapsed</code></pre>
<pre class="r"><code>combined_assignee_patent_assignee_tbl %&gt;%
    select(organization, number_of_patents) %&gt;%
    arrange(desc(number_of_patents)) %&gt;%
    slice(1:11) %&gt;%
    filter(organization!=&quot;&quot;)</code></pre>
<pre><code>## # A tibble: 10 x 2
##    organization                                number_of_patents
##    &lt;chr&gt;                                                   &lt;dbl&gt;
##  1 International Business Machines Corporation            141100
##  2 Samsung Electronics Co., Ltd.                           95246
##  3 Canon Kabushiki Kaisha                                  76700
##  4 Sony Corporation                                        54889
##  5 Kabushiki Kaisha Toshiba                                49715
##  6 General Electric Company                                47545
##  7 Hitachi, Ltd.                                           45521
##  8 Intel Corporation                                       42962
##  9 Fujitsu Limited                                         37461
## 10 Hewlett-Packard Development Company, L.P.               36002</code></pre>
</div>
<div id="recent-patent-acitivity--" class="section level2">
<h2><span class="header-section-number">4.2</span> 2.0 Recent Patent Acitivity —-</h2>
<ol start="2" style="list-style-type: decimal">
<li>Recent patent activity: What US company had the most patents granted in 2019? List the top 10 companies with the most new granted patents for 2019.</li>
</ol>
<pre class="r"><code>#install.packages(&quot;vroom&quot;)
#install.packages(&quot;tictoc&quot;)

# Tidyverse
library(tidyverse)
library(vroom)

# Data Table
library(data.table)

# Counter
library(tictoc)

col_types_assignee_tbl &lt;- list(
  id = col_character(),
  type = col_double(),
  name_first = col_character(),
  name_last = col_character(),
  organization = col_character()
)

#assignee_tbl &lt;- vroom(
            #file       = &quot;00_data/04_challenge/assignee.tsv&quot;, 
            #delim      = &quot;\t&quot;, 
            #col_types  = col_types_assignee_tbl,
            #na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        #)

col_types_patent_tbl &lt;- list(
  id = col_character(),
  type = col_character(),
  number = col_character(),
  country = col_character(),
  date = col_date(&quot;%Y-%m-%d&quot;),
  abstract = col_character(),
  title = col_character(),
  kind = col_character(),
  num_claims = col_double(),
  filename = col_character(),
  withdrawn = col_double()
)

#patent_tbl &lt;- vroom(
 #           file       = &quot;00_data/04_challenge/patent.tsv&quot;, 
  #          delim      = &quot;\t&quot;, 
   #         col_types  = col_types_patent_tbl,
    #        na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
     #   )

col_types_patent_assignee_tbl &lt;- list(
  patent_id = col_character(),
  assignee_id = col_character(),
  location_id = col_character()
)

#patent_assignee_tbl &lt;- vroom(
 #           file       = &quot;00_data/04_challenge/patent_assignee.tsv&quot;, 
  #          delim      = &quot;\t&quot;, 
   #         col_types  = col_types_patent_assignee_tbl,
    #        na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
     #   )

#col_types_uspc_tbl &lt;- list(
 # uuid = col_character(),
  #patent_id = col_character(),
  #mainclass_id = col_character(),
  #subclass_id = col_character(),
  #sequence = col_double()
#)

#uspc_tbl &lt;- vroom(
 #           file       = &quot;00_data/04_challenge/uspc.tsv&quot;, 
  #          delim      = &quot;\t&quot;, 
   #         col_types  = col_types_uspc_tbl,
    #        na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
     #   )

#assignee_tbl %&gt;% glimpse()
#patent_tbl %&gt;% glimpse()
#patent_assignee_tbl %&gt;% glimpse()
#uspc_tbl %&gt;% glimpse()

#class(assignee_tbl)
#class(patent_tbl)
#class(patent_assignee_tbl)
#class(uspc_tbl)

#setDT(assignee_tbl)
#setDT(patent_tbl)
#setDT(patent_assignee_tbl)
#setDT(uspc_tbl)

#class(assignee_tbl)
#class(patent_tbl)
#class(patent_assignee_tbl)
#class(uspc_tbl)

#assignee_tbl %&gt;% glimpse()
#patent_tbl %&gt;% glimpse()
#patent_assignee_tbl %&gt;% glimpse()
#uspc_tbl %&gt;% glimpse()

# 4.0 DATA WRANGLING ----
# 4.1 Joining / Merging Data ----

#tic()
#combined_assignee_patent_assignee_tbl &lt;- merge(x = assignee_tbl, y = patent_assignee_tbl, 
                       #by.x = &quot;id&quot;, by.y = &quot;assignee_id&quot;,
                       #all.x = TRUE, 
                       #all.y = TRUE)%&gt;%
#mutate(patents_unit=1)%&gt;%
 #group_by(organization) %&gt;%
  #summarize(number_of_patents = sum(patents_unit)) %&gt;%
  #ungroup()%&gt;%
  #arrange(number_of_patents)
#toc()

#combined_assignee_patent_assignee_tbl %&gt;%
    #select(organization, number_of_patents) %&gt;%
    #arrange(desc(number_of_patents)) %&gt;%
    #slice(1:11) %&gt;%
    #filter(organization!=&quot;&quot;)</code></pre>
</div>
<div id="innovation-in-tech--" class="section level2">
<h2><span class="header-section-number">4.3</span> 3.0 Innovation in Tech —-</h2>
<ol start="3" style="list-style-type: decimal">
<li>Innovation in Tech: What is the most innovative tech sector? For the top 10 companies (worldwide) with the most patents, what are the top 5 USPTO tech main classes?</li>
</ol>
<pre class="r"><code>library(tidyverse)</code></pre>
</div>
</div>
<div id="challenge-05_data-visualisation" class="section level1">
<h1><span class="header-section-number">5</span> Challenge 05_Data Visualisation</h1>
<p>Answer the following questions with that data:</p>
<div id="challenge-05.1--" class="section level2">
<h2><span class="header-section-number">5.1</span> Challenge 05.1 —-</h2>
<p>Goal: Map the time course of the cumulative Covid-19 cases! Your plot should look like this: Adding the cases for Europe is optional. You can choose your own color theme, but don’t use the default one. Don’t forget to scale the axis properly. The labels can be added with geom_label() or with geom_label_repel() (from the package ggrepel).</p>
<pre class="r"><code>library(vroom)
library(tidyverse)
library(data.table)
library(dplyr)
library(base)


#covid_data_tbl &lt;- read_csv(&quot;https://opendata.ecdc.europa.eu/covid19/casedistribution/csv&quot;)
    
    col_types_covid_data_tbl &lt;- list(
    dateRep = col_date(&quot;%d/%m/%Y&quot;),
    year_week = col_character(),
    cases_weekly = col_double(),
    deaths_weekly = col_double(),
    countriesAndTerritories = col_character(),
    geoId = col_character(),
    countryterritoryCode = col_character(),
    popData2019 = col_double(),
    continentExp = col_character(),
    `notification_rate_per_100000_population_14-days` = col_double()
    )
   
covid_data_tbl &lt;- vroom(
            file       = &quot;https://opendata.ecdc.europa.eu/covid19/casedistribution/csv&quot;, 
            delim      = &quot;,&quot;, 
            col_types  = col_types_covid_data_tbl,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )

covid_data_cumulative_by_month_tbl &lt;- covid_data_tbl %&gt;%
    
    # Select relevant columns
    select(dateRep, cases_weekly, countriesAndTerritories) %&gt;%
    mutate(month = month(dateRep)) %&gt;%
    mutate(month_name = months(dateRep)) %&gt;%
    mutate(year = year(dateRep)) %&gt;%
    filter(year==&quot;2020&quot;)%&gt;%
    group_by(month, month_name, countriesAndTerritories) %&gt;%  
    summarize(cases_month = sum(cases_weekly)) %&gt;%
    arrange(countriesAndTerritories)%&gt;%
    group_by(countriesAndTerritories) %&gt;%
    mutate(cases_month_aux = ifelse( is.na(cases_month), 0, cases_month ), #remove NA
          cum_cases_month = cumsum(cases_month_aux) )%&gt;%
    mutate(cum_cases_month_abbr = scales::dollar(cum_cases_month, 
                                                      scale = 1e-6, 
                                                      prefix       = &quot;&quot;, 
                                                      suffix       = &quot; M&quot;)) %&gt;%
    mutate(cum_cases_month_in_millions = cum_cases_month/1e6) %&gt;%
    select(month,countriesAndTerritories, cases_month, cum_cases_month, month_name, cum_cases_month_abbr, cum_cases_month_in_millions )
    
covid_data_cumulative_by_month_tbl %&gt;%
filter(countriesAndTerritories %in% c(&quot;United_Kingdom&quot;,&quot;United_States_of_America&quot;, &quot;Germany&quot;, &quot;Spain&quot;, &quot;France&quot;, &quot;Brazil&quot;))%&gt;%

  # Set up x, y, fill
  ggplot(aes(x = factor(month_name, 
                        level=c(&quot;Januar&quot;, &quot;Februar&quot;, &quot;März&quot;, &quot;April&quot;, &quot;Mai&quot;, &quot;Juni&quot;, &quot;Juli&quot;, &quot;August&quot;, &quot;September&quot;,&quot;Oktober&quot;, &quot;November&quot;, &quot;Dezember&quot;)), 
                        y = cum_cases_month_in_millions, group=countriesAndTerritories, color=countriesAndTerritories)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  # Geometries
  geom_point() +
  geom_line(aes(label=countriesAndTerritories)) +
  #geom_smooth(method = &quot;lm&quot;, se = FALSE)+
  
  #scale_x_continuous(breaks = seq(1, 12, by=1)) +
  #scale_y_discrete() +
  #xlim(1,12)+
  ylim(0, 20)+
  
  #verify with Prof geom_label
  #geom_label(label = covid_data_cumulative_by_month_tbl %&gt;%
   #                   filter(cum_cases_month_in_millions &gt; 1000000),
    #           vjust = -0.5, 
     #          size  = 3,
      #         fill  = &quot;#1f78b4&quot;,
       #        color = &quot;white&quot;,
        #       fontface = &quot;italic&quot;,
         #      data = covid_data_cumulative_by_month_tbl %&gt;%
          #            filter(cum_cases_month_in_millions &gt; 1000000)) +
    
labs(
      title = &quot;COVID-19 Confirmed Cases Worldwide&quot;,
      subtitle = &quot;-&quot;,
      x = &quot;YEAR 2020&quot;,
      y = &quot;Cumulative Cases (in millions)&quot;
      )</code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="challenge-05.2--" class="section level2">
<h2><span class="header-section-number">5.2</span> Challenge 05.2 —-</h2>
<p>Goal: Visualize the distribution of the mortality rate (deaths / population) with geom_map(). The necessary longitudinal and lateral data can be accessed with this function:</p>
<p>world &lt;- map_data(“world”)</p>
<p>This data has also to be put in the map argument of geom_map():</p>
<p>plot_data %&gt;% ggplot( … ) + geom_map(aes(map_id = …, … ), map = world, … ) + …</p>
<pre class="r"><code>library(tidyverse)
#install.packages(&quot;maps&quot;)
library(maps)
library(vroom)
library(data.table)
library(dplyr)
library(base)
library(tictoc)

world &lt;- map_data(&quot;world&quot;)
col_types_covid_data_tbl &lt;- list(
    dateRep = col_date(&quot;%d/%m/%Y&quot;),
    year_week = col_character(),
    cases_weekly = col_double(),
    deaths_weekly = col_double(),
    countriesAndTerritories = col_character(),
    geoId = col_character(),
    countryterritoryCode = col_character(),
    popData2019 = col_double(),
    continentExp = col_character(),
    `notification_rate_per_100000_population_14-days` = col_double()
    )
   
covid_data_tbl &lt;- vroom(
            file       = &quot;https://opendata.ecdc.europa.eu/covid19/casedistribution/csv&quot;, 
            delim      = &quot;,&quot;, 
            col_types  = col_types_covid_data_tbl,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )
covid_data_cumulative_death_by_country_tbl &lt;- covid_data_tbl %&gt;%
    
    # Select relevant columns
    select(dateRep,countriesAndTerritories,deaths_weekly, popData2019) %&gt;%
    mutate(year = year(dateRep)) %&gt;%
    filter(year==&quot;2020&quot;)%&gt;%
    group_by(countriesAndTerritories, popData2019) %&gt;%  
    summarize(deaths_sum = sum(deaths_weekly)) %&gt;%
    arrange(countriesAndTerritories)%&gt;%
    mutate(mortality_per_million= deaths_sum/popData2019*100*1000)
  
#tic()
#combined_covid_death_world_tbl &lt;- merge(x = covid_data_cumulative_death_by_country_tbl, y = world, 
#                       by.x = &quot;countriesAndTerritories&quot;, by.y = &quot;region&quot;,
#                       all.x = TRUE, 
#                       all.y = TRUE)%&gt;%
#mutate(patents_unit=1)%&gt;%
# group_by(organization) %&gt;%
 # summarize(number_of_patents = sum(patents_unit)) %&gt;%
# # ungroup()%&gt;%
#arrange(number_of_patents)
#toc()

#combined_assignee_patent_assignee_tbl %&gt;%
   # select(organization, number_of_patents) %&gt;%
  #  arrange(desc(number_of_patents)) %&gt;%
  #  slice(1:11) %&gt;%
  #  filter(organization!=&quot;&quot;)



#cas &lt;- covid_data_cumulative_death_by_country_tbl %&gt;%
  #  select(countriesAndTerritories,deaths_sum, popData2019, mortality_per_million)%&gt;%
  #  mutate(across(countriesAndTerritories, str_replace_all, &quot;_&quot;, &quot; &quot;)) %&gt;%
  #  mutate(countriesAndTerritories = case_when(countriesAndTerritories == &quot;United Kingdom&quot; ~ &quot;UK&quot;,
    #      countriesAndTerritories == &quot;United States of America&quot; ~ &quot;USA&quot;,
      #    countriesAndTerritories == &quot;Czechia&quot; ~ &quot;Czech Republic&quot;,
      #    TRUE ~ countriesAndTerritories
       #   ))
#</code></pre>
</div>
</div>
<div id="challenge-06_machine-learning-fundamentals" class="section level1">
<h1><span class="header-section-number">6</span> Challenge 06_Machine Learning Fundamentals</h1>
<div id="summary" class="section level2">
<h2><span class="header-section-number">6.1</span> Summary</h2>
<p><strong>Your organization wants to know which companies are similar to each other to help in identifying potential customers of a SAAS software solution (e.g. Salesforce CRM or equivalent) in various segments of the market. The Sales Department is very interested in this analysis, which will help them more easily penetrate various market segments.</strong></p>
<p>You will be using stock prices in this analysis. You come up with a method to classify companies based on how their stocks trade using their daily stock returns (percentage movement from one day to the next). This analysis will help your organization determine which companies are related to each other (competitors and have similar attributes).</p>
<p>You can analyze the stock prices using what you’ve learned in the unsupervised learning tools including K-Means and UMAP. You will use a combination of <code>kmeans()</code> to find groups and <code>umap()</code> to visualize similarity of daily stock returns.</p>
</div>
<div id="objectives" class="section level2">
<h2><span class="header-section-number">6.2</span> Objectives</h2>
<p>Apply your knowledge on K-Means and UMAP along with <code>dplyr</code>, <code>ggplot2</code>, and <code>purrr</code> to create a visualization that identifies subgroups in the S&amp;P 500 Index. You will specifically apply:</p>
<ul>
<li>Modeling: <code>kmeans()</code> and <code>umap()</code></li>
<li>Iteration: <code>purrr</code></li>
<li>Data Manipulation: <code>dplyr</code>, <code>tidyr</code>, and <code>tibble</code></li>
<li>Visualization: <code>ggplot2</code> (bonus <code>plotly</code>)</li>
</ul>
</div>
<div id="libraries" class="section level2">
<h2><span class="header-section-number">6.3</span> Libraries</h2>
<p>Load the following libraries.</p>
<pre class="r"><code>#install.packages(&quot;plotly&quot;)
#install.packages(&quot;tidyquant&quot;)
#install.packages(&quot;umap&quot;)

library(tidyverse)
library(tidyquant)
library(broom)
library(umap)</code></pre>
</div>
<div id="data" class="section level2">
<h2><span class="header-section-number">6.4</span> Data</h2>
<p>We will be using stock prices in this analysis. Although some of you know already how to use an API to retrieve stock prices I obtained the stock prices for every stock in the S&amp;P 500 index for you already. The files are saved in the <code>session_6_data</code> directory.</p>
<p>We can read in the stock prices. The data is 1.2M observations. The most important columns for our analysis are:</p>
<ul>
<li><code>symbol</code>: The stock ticker symbol that corresponds to a company’s stock price</li>
<li><code>date</code>: The timestamp relating the symbol to the share price at that point in time</li>
<li><code>adjusted</code>: The stock price, adjusted for any splits and dividends (we use this when analyzing stock data over long periods of time)</li>
</ul>
<pre class="r"><code># STOCK PRICES
sp_500_prices_tbl &lt;- read_rds(&quot;00_data/06/sp_500_prices_tbl.rds&quot;)
#sp_500_prices_tbl</code></pre>
<p>The second data frame contains information about the stocks the most important of which are:</p>
<ul>
<li><code>company</code>: The company name</li>
<li><code>sector</code>: The sector that the company belongs to</li>
</ul>
<pre class="r"><code># SECTOR INFORMATION
#sp_500_index_tbl &lt;- read_rds(&quot;sp_500_index_tbl.rds&quot;)
#sp_500_index_tbl</code></pre>
</div>
<div id="question" class="section level2">
<h2><span class="header-section-number">6.5</span> Question</h2>
<p><mark>Which stock prices behave similarly?</mark></p>
<p>Answering this question helps us <strong>understand which companies are related</strong>, and we can use clustering to help us answer it!</p>
<p>Even if you’re not interested in finance, this is still a great analysis because it will tell you which companies are competitors and which are likely in the same space (often called sectors) and can be categorized together. Bottom line - This analysis can help you better understand the dynamics of the market and competition, which is useful for all types of analyses from finance to sales to marketing.</p>
<p>Let’s get started.</p>
<div id="step-1---convert-stock-prices-to-a-standardized-format-daily-returns" class="section level3">
<h3><span class="header-section-number">6.5.1</span> Step 1 - Convert stock prices to a standardized format (daily returns)</h3>
<p>What you first need to do is get the data in a format that can be converted to a “user-item” style matrix. The challenge here is to connect the dots between what we have and what we need to do to format it properly.</p>
<p>We know that in order to compare the data, it needs to be standardized or normalized. Why? Because we cannot compare values (stock prices) that are of completely different magnitudes. In order to standardize, we will convert from adjusted stock price (dollar value) to daily returns (percent change from previous day). Here is the formula.</p>
<p><span class="math display">\[ 
return_{daily} = \frac{price_{i}-price_{i-1}}{price_{i-1}}
\]</span></p>
<p>First, what do we have? We have stock prices for every stock in the <a href="https://finance.yahoo.com/quote/%5EGSPC?p=%5EGSPC">SP 500 Index</a>, which is the daily stock prices for over 500 stocks. The data set is over 1.2M observations.</p>
<pre class="r"><code>sp_500_prices_tbl %&gt;% glimpse()</code></pre>
<pre><code>## Rows: 1,225,765
## Columns: 8
## $ symbol   &lt;chr&gt; &quot;MSFT&quot;, &quot;MSFT&quot;, &quot;MSFT&quot;, &quot;MSFT&quot;, &quot;MSFT&quot;, &quot;MSFT&quot;, &quot;MSFT&quot;, &quot;M...
## $ date     &lt;date&gt; 2009-01-02, 2009-01-05, 2009-01-06, 2009-01-07, 2009-01-0...
## $ open     &lt;dbl&gt; 19.53, 20.20, 20.75, 20.19, 19.63, 20.17, 19.71, 19.52, 19...
## $ high     &lt;dbl&gt; 20.40, 20.67, 21.00, 20.29, 20.19, 20.30, 19.79, 19.99, 19...
## $ low      &lt;dbl&gt; 19.37, 20.06, 20.61, 19.48, 19.55, 19.41, 19.30, 19.52, 19...
## $ close    &lt;dbl&gt; 20.33, 20.52, 20.76, 19.51, 20.12, 19.52, 19.47, 19.82, 19...
## $ volume   &lt;dbl&gt; 50084000, 61475200, 58083400, 72709900, 70255400, 49815300...
## $ adjusted &lt;dbl&gt; 15.86624, 16.01451, 16.20183, 15.22628, 15.70234, 15.23408...</code></pre>
<p>Your first task is to convert to a tibble named <code>sp_500_daily_returns_tbl</code> by performing the following operations:</p>
<ul>
<li>Select the <code>symbol</code>, <code>date</code> and <code>adjusted</code> columns</li>
<li>Filter to dates beginning in the year 2018 and beyond.</li>
<li>Compute a Lag of 1 day on the adjusted stock price. Be sure to group by symbol first, otherwise we will have lags computed using values from the previous stock in the data frame.</li>
<li>Remove a <code>NA</code> values from the lagging operation</li>
<li>Compute the difference between adjusted and the lag</li>
<li>Compute the percentage difference by dividing the difference by that lag. Name this column <code>pct_return</code>.</li>
<li>Return only the <code>symbol</code>, <code>date</code>, and <code>pct_return</code> columns</li>
<li>Save as a variable named <code>sp_500_daily_returns_tbl</code></li>
</ul>
<pre class="r"><code># Apply your data transformation skills!

# Output: sp_500_daily_returns_tbl</code></pre>
</div>
<div id="step-2---convert-to-user-item-format" class="section level3">
<h3><span class="header-section-number">6.5.2</span> Step 2 - Convert to User-Item Format</h3>
<p>The next step is to convert to a user-item format with the <code>symbol</code> in the first column and every other column the value of the <em>daily returns</em> (<code>pct_return</code>) for every stock at each <code>date</code>.</p>
<p>We’re going to import the correct results first (just in case you were not able to complete the last step).</p>
<pre class="r"><code>#sp_500_daily_returns_tbl &lt;- read_rds(&quot;sp_500_daily_returns_tbl.rds&quot;)
#sp_500_daily_returns_tbl</code></pre>
<p>Now that we have the daily returns (percentage change from one day to the next), we can convert to a user-item format. The user in this case is the <code>symbol</code> (company), and the item in this case is the <code>pct_return</code> at each <code>date</code>.</p>
<ul>
<li>Spread the <code>date</code> column to get the values as percentage returns. Make sure to fill an <code>NA</code> values with zeros.</li>
<li>Save the result as <code>stock_date_matrix_tbl</code></li>
</ul>
<pre class="r"><code># Convert to User-Item Format

# Output: stock_date_matrix_tbl</code></pre>
</div>
<div id="step-3---perform-k-means-clustering" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Step 3 - Perform K-Means Clustering</h3>
<p>Next, we’ll perform <strong>K-Means clustering</strong>.</p>
<p>We’re going to import the correct results first (just in case you were not able to complete the last step).</p>
<pre class="r"><code>#stock_date_matrix_tbl &lt;- read_rds(&quot;stock_date_matrix_tbl.rds&quot;)</code></pre>
<p>Beginning with the <code>stock_date_matrix_tbl</code>, perform the following operations:</p>
<ul>
<li>Drop the non-numeric column, <code>symbol</code></li>
<li>Perform <code>kmeans()</code> with <code>centers = 4</code> and <code>nstart = 20</code></li>
<li>Save the result as <code>kmeans_obj</code></li>
</ul>
<pre class="r"><code># Create kmeans_obj for 4 centers</code></pre>
<p>Use <code>glance()</code> to get the <code>tot.withinss</code>.</p>
<pre class="r"><code># Apply glance() to get the tot.withinss</code></pre>
</div>
<div id="step-4---find-the-optimal-value-of-k" class="section level3">
<h3><span class="header-section-number">6.5.4</span> Step 4 - Find the optimal value of K</h3>
<p>Now that we are familiar with the process for calculating <code>kmeans()</code>, let’s use <code>purrr</code> to iterate over many values of “k” using the <code>centers</code> argument.</p>
<p>We’ll use this <strong>custom function</strong> called <code>kmeans_mapper()</code>:</p>
<pre class="r"><code>#kmeans_mapper &lt;- function(center = 3) {
 #   stock_date_matrix_tbl %&gt;%
  #      select(-symbol) %&gt;%
   #     kmeans(centers = center, nstart = 20)
#}</code></pre>
<p>Apply the <code>kmeans_mapper()</code> and <code>glance()</code> functions iteratively using <code>purrr</code>.</p>
<ul>
<li>Create a tibble containing column called <code>centers</code> that go from 1 to 30</li>
<li>Add a column named <code>k_means</code> with the <code>kmeans_mapper()</code> output. Use <code>mutate()</code> to add the column and <code>map()</code> to map centers to the <code>kmeans_mapper()</code> function.</li>
<li>Add a column named <code>glance</code> with the <code>glance()</code> output. Use <code>mutate()</code> and <code>map()</code> again to iterate over the column of <code>k_means</code>.</li>
<li>Save the output as <code>k_means_mapped_tbl</code></li>
</ul>
<pre class="r"><code># Use purrr to map


# Output: k_means_mapped_tbl </code></pre>
<p>Next, let’s visualize the “tot.withinss” from the glance output as a <strong><em>Scree Plot</em></strong>.</p>
<ul>
<li>Begin with the <code>k_means_mapped_tbl</code></li>
<li>Unnest the <code>glance</code> column</li>
<li>Plot the <code>centers</code> column (x-axis) versus the <code>tot.withinss</code> column (y-axis) using <code>geom_point()</code> and <code>geom_line()</code></li>
<li>Add a title “Scree Plot” and feel free to style it with your favorite theme</li>
</ul>
<pre class="r"><code># Visualize Scree Plot</code></pre>
<p>We can see that the Scree Plot becomes linear (constant rate of change) between 5 and 10 centers for K.</p>
</div>
<div id="step-5---apply-umap" class="section level3">
<h3><span class="header-section-number">6.5.5</span> Step 5 - Apply UMAP</h3>
<p>Next, let’s plot the <code>UMAP</code> 2D visualization to help us investigate cluster assignments.</p>
<p>We’re going to import the correct results first (just in case you were not able to complete the last step).</p>
<pre class="r"><code>#k_means_mapped_tbl &lt;- read_rds(&quot;k_means_mapped_tbl.rds&quot;)</code></pre>
<p>First, let’s apply the <code>umap()</code> function to the <code>stock_date_matrix_tbl</code>, which contains our user-item matrix in tibble format.</p>
<ul>
<li>Start with <code>stock_date_matrix_tbl</code></li>
<li>De-select the <code>symbol</code> column</li>
<li>Use the <code>umap()</code> function storing the output as <code>umap_results</code></li>
</ul>
<pre class="r"><code># Apply UMAP

# Store results as: umap_results </code></pre>
<p>Next, we want to combine the <code>layout</code> from the <code>umap_results</code> with the <code>symbol</code> column from the <code>stock_date_matrix_tbl</code>.</p>
<ul>
<li>Start with <code>umap_results$layout</code></li>
<li>Convert from a <code>matrix</code> data type to a <code>tibble</code> with <code>as_tibble()</code></li>
<li>Bind the columns of the umap tibble with the <code>symbol</code> column from the <code>stock_date_matrix_tbl</code>.</li>
<li>Save the results as <code>umap_results_tbl</code>.</li>
</ul>
<pre class="r"><code># Convert umap results to tibble with symbols

# Output: umap_results_tbl</code></pre>
<p>Finally, let’s make a quick visualization of the <code>umap_results_tbl</code>.</p>
<ul>
<li>Pipe the <code>umap_results_tbl</code> into <code>ggplot()</code> mapping the columns to x-axis and y-axis</li>
<li>Add a <code>geom_point()</code> geometry with an <code>alpha = 0.5</code></li>
<li>Apply <code>theme_tq()</code> and add a title “UMAP Projection”</li>
</ul>
<pre class="r"><code># Visualize UMAP results</code></pre>
<p>We can now see that we have some clusters. However, we still need to combine the K-Means clusters and the UMAP 2D representation.</p>
</div>
<div id="step-6---combine-k-means-and-umap" class="section level3">
<h3><span class="header-section-number">6.5.6</span> Step 6 - Combine K-Means and UMAP</h3>
<p>Next, we combine the K-Means clusters and the UMAP 2D representation</p>
<p>We’re going to import the correct results first (just in case you were not able to complete the last step).</p>
<pre class="r"><code>#k_means_mapped_tbl &lt;- read_rds(&quot;k_means_mapped_tbl.rds&quot;)
#umap_results_tbl   &lt;- read_rds(&quot;umap_results_tbl.rds&quot;)</code></pre>
<p>First, pull out the K-Means for 10 Centers. Use this since beyond this value the Scree Plot flattens. Have a look at the business case to recall how that works.</p>
<pre class="r"><code># Get the k_means_obj from the 10th center

# Store as k_means_obj</code></pre>
<p>Next, we’ll combine the clusters from the <code>k_means_obj</code> with the <code>umap_results_tbl</code>.</p>
<ul>
<li>Begin with the <code>k_means_obj</code></li>
<li>Augment the <code>k_means_obj</code> with the <code>stock_date_matrix_tbl</code> to get the clusters added to the end of the tibble</li>
<li>Select just the <code>symbol</code> and <code>.cluster</code> columns</li>
<li>Left join the result with the <code>umap_results_tbl</code> by the <code>symbol</code> column</li>
<li>Left join the result with the result of <code>sp_500_index_tbl %&gt;% select(symbol, company, sector)</code> by the <code>symbol</code> column.</li>
<li>Store the output as <code>umap_kmeans_results_tbl</code></li>
</ul>
<pre class="r"><code># Use your dplyr &amp; broom skills to combine the k_means_obj with the umap_results_tbl


# Output: umap_kmeans_results_tbl </code></pre>
<p>Plot the K-Means and UMAP results.</p>
<ul>
<li>Begin with the <code>umap_kmeans_results_tbl</code></li>
<li>Use <code>ggplot()</code> mapping <code>V1</code>, <code>V2</code> and <code>color = .cluster</code></li>
<li>Add the <code>geom_point()</code> geometry with <code>alpha = 0.5</code></li>
<li>Apply colors as you desire (e.g. <code>scale_color_manual(values = palette_light() %&gt;% rep(3))</code>)</li>
</ul>
<pre class="r"><code># Visualize the combined K-Means and UMAP results</code></pre>
<p>Congratulations! You are done with the 1st challenge!</p>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
